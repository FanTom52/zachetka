<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <div class="user-info">
                <span id="userName"></span>
                <button onclick="logout()" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
                <button onclick="window.location.href='index.html'" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>
        </header>

        <div class="card">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è!</h2>
            <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã.</p>
            
            <div class="admin-links">
                <button onclick="manageUsers()" class="btn btn-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
                <button onclick="viewStatistics()" class="btn btn-primary">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</button>
            </div>
            
            <div id="adminContent" class="admin-content">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –≤—ã—à–µ</p>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function checkAuth() {
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    if (currentUser.role !== 'admin') {
                        alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    document.getElementById('userName').textContent = currentUser.username;
                } else {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }

        async function manageUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    let html = '<h3>üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>';
                    
                    if (result.data.length === 0) {
                        html += '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    } else {
                        html += '<table class="data-table"><tr><th>ID</th><th>–õ–æ–≥–∏–Ω</th><th>–†–æ–ª—å</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th></tr>';
                        
                        result.data.forEach(user => {
                            let roleBadge = '';
                            switch(user.role) {
                                case 'admin': roleBadge = '<span class="role-badge role-admin">–ê–¥–º–∏–Ω</span>'; break;
                                case 'teacher': roleBadge = '<span class="role-badge role-teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</span>'; break;
                                case 'student': roleBadge = '<span class="role-badge role-student">–°—Ç—É–¥–µ–Ω—Ç</span>'; break;
                            }
                            
                            html += `<tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${roleBadge}</td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            </tr>`;
                        });
                        
                        html += '</table>';
                    }
                    
                    document.getElementById('adminContent').innerHTML = html;
                } else {
                    document.getElementById('adminContent').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('adminContent').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function viewStatistics() {
            try {
                const response = await fetch('/api/statistics/overview', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('adminContent').innerHTML = `
                        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h4>üë• –°—Ç—É–¥–µ–Ω—Ç—ã</h4>
                                <p>${stats.students || 0}</p>
                            </div>
                            <div class="stat-card">
                                <h4>üë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h4>
                                <p>${stats.teachers || 0}</p>
                            </div>
                            <div class="stat-card">
                                <h4>üìö –ü—Ä–µ–¥–º–µ—Ç—ã</h4>
                                <p>${stats.subjects || 0}</p>
                            </div>
                            <div class="stat-card">
                                <h4>üìù –û—Ü–µ–Ω–∫–∏</h4>
                                <p>${stats.grades || 0}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('adminContent').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        checkAuth();
    </script>
</body>
</html>